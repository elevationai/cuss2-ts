<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUSS2 Interactive Tester - Vue</title>
    <link rel="stylesheet" href="css/tester.css">
    <!-- Vue 3 CDN (no build step) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <a href="index.html" class="back-link">&larr; Back to Examples</a>
        <h1>CUSS2 Interactive Tester</h1>
        <p class="subtitle">Testing interface for the CUSS2 platform with full component interaction capabilities</p>

        <div class="grid">
          <!-- Connection Panel (shown when not connected) -->
          <div v-if="!isConnected" class="panel panel-centered">
            <h2>Connection</h2>
            <form @submit.prevent="handleSubmit" class="connection-form">
              <div class="form-group">
                <label for="wss">WebSocket URL</label>
                <input type="text" id="wss" v-model="form.wss"
                       :class="{ error: fieldErrors.wss, 'field-problem': fieldProblem === 'wss' }"
                       @blur="onFieldBlur('wss')" @input="onFieldInput('wss')" required>
                <div v-if="fieldErrors.wss" class="field-error">{{ fieldErrors.wss }}</div>
              </div>
              <div class="form-group">
                <label for="clientId">Client ID</label>
                <input type="text" id="clientId" v-model="form.clientId" required>
              </div>
              <div class="form-group">
                <label for="clientSecret">Client Secret</label>
                <input type="password" id="clientSecret" v-model="form.clientSecret" required>
              </div>
              <div class="form-group">
                <label for="deviceId">Device ID (optional)</label>
                <input type="text" id="deviceId" v-model="form.deviceId" placeholder="Leave empty for default">
              </div>
              <div class="form-group">
                <label for="tokenUrl">Token URL (optional)</label>
                <div class="token-url-container">
                  <input type="text" id="tokenUrl" v-model="form.tokenUrl"
                         :placeholder="tokenUrlPlaceholder"
                         :class="{ error: fieldErrors.tokenUrl, 'field-problem': fieldProblem === 'tokenUrl' }"
                         @blur="onFieldBlur('tokenUrl')" @input="onFieldInput('tokenUrl')">
                  <button type="button" class="generate-token-btn"
                          :disabled="generateButtonDisabled"
                          @click="generateTokenUrl">{{ generateButtonText }}</button>
                </div>
                <div v-if="fieldErrors.tokenUrl" class="field-error">{{ fieldErrors.tokenUrl }}</div>
              </div>

              <!-- Connect button (shown when not connecting) -->
              <div v-if="!isConnecting">
                <button type="submit">Connect</button>
              </div>

              <!-- Connection progress (shown when connecting) -->
              <div v-if="isConnecting" class="connection-status-container">
                <div class="connection-progress-indicator">
                  <div class="connection-progress-header">
                    <span style="font-weight: 600; font-size: 16px; color: #e0e0e0;">{{ progressTitle }}</span>
                    <button type="button" class="cancel-connection-btn" @click="cancelConnection">Cancel</button>
                  </div>
                  <div class="connection-stages">
                    <div v-for="(stage, stageName) in connectionStages" :key="stageName"
                         class="connection-stage" :class="'stage-' + stage.state">
                      <div class="stage-icon">{{ stageIcon(stage.state) }}</div>
                      <div class="stage-content">
                        <div class="stage-label">{{ stageName === 'auth' ? 'Authentication' : 'WebSocket Connection' }}</div>
                        <div class="stage-status">{{ stageStatusText(stageName, stage) }}</div>
                      </div>
                      <div class="stage-attempts">{{ stageAttemptsText(stage) }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- State Management Panel (shown when connected) -->
          <div v-if="isConnected" class="panel">
            <div class="panel-header">
              <h2>State Management</h2>
              <button type="button" class="disconnect-btn-header" @click="disconnect">Disconnect</button>
            </div>

            <div>
              <strong>Current State:</strong>
              <span class="state-badge" :class="appState">{{ appState }}</span>
            </div>

            <div v-if="showUnavailableWarning" class="availability-reasons-warning">
              <strong>Application forced to UNAVAILABLE</strong> because 1 or more required devices are unhealthy.
            </div>

            <div class="actions">
              <button v-for="action in ['initialize', 'unavailable', 'available', 'active', 'stopped', 'reload']"
                      :key="action"
                      :disabled="!isTransitionAllowed(action)"
                      @click="requestState(action)">
                {{ action.charAt(0).toUpperCase() + action.slice(1) }}
              </button>
            </div>

            <h3>
              Application Info
              <label style="margin-left: 15px; font-weight: normal;">
                <input type="checkbox" v-model="isOnline" @change="onIsOnlineChange">
                isOnline
              </label>
            </h3>
            <div style="font-size: 14px">
              <div>Brand: <span>{{ appInfo.brand }}</span></div>
              <div>Multi-tenant: <span>{{ appInfo.multiTenant }}</span></div>
              <div>Accessible Mode: <span>{{ appInfo.accessibleMode }}</span></div>
              <div>Language: <span>{{ appInfo.language }}</span></div>
            </div>

            <h3>Required Devices</h3>
            <div class="availability-reasons">
              <div v-if="computedRequiredDeviceItems.length === 0" class="availability-reasons-empty">
                No required devices are configured for this application.
              </div>
              <template v-else>
                <div v-for="device in computedRequiredDeviceItems" :key="device.id"
                     class="availability-reason-item" :class="device.rowClass">
                  <div class="availability-reason-title">{{ device.name }}</div>
                  <div class="availability-reason-tags">
                    <span v-for="(tag, i) in device.tags" :key="i"
                          class="availability-reason-tag" :class="tag.className">
                      {{ tag.text }}
                    </span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Environment Panel (shown when connected) -->
          <div v-if="isConnected && environment" class="panel">
            <h2>Environment</h2>
            <div class="env-group"><strong>Device Information</strong></div>
            <div class="env-item"><span class="env-label">Device ID:</span> <span class="env-value">{{ fmtValue(environment.deviceID) }}</span></div>
            <div class="env-item"><span class="env-label">Device Name:</span> <span class="env-value">{{ fmtValue(environment.deviceModelName) }}</span></div>
            <div class="env-item"><span class="env-label">Airport Code:</span> <span class="env-value">{{ fmtValue(environment.airportCode) }}</span></div>
            <div class="env-item"><span class="env-label">Terminal:</span> <span class="env-value">{{ fmtValue(environment.terminalID) }}</span></div>
            <div class="env-item"><span class="env-label">Gate:</span> <span class="env-value">{{ fmtValue(environment.gateID) }}</span></div>
            <div class="env-group"><strong>CUSS Platform</strong></div>
            <div class="env-item"><span class="env-label">CUSS Versions:</span> <span class="env-value">{{ Array.isArray(environment.cussVersions) ? environment.cussVersions.join(', ') : fmtValue(environment.cussVersions) }}</span></div>
            <div class="env-item"><span class="env-label">OS Name:</span> <span class="env-value">{{ fmtValue(environment.osName) }}</span></div>
            <div class="env-item"><span class="env-label">OS Version:</span> <span class="env-value">{{ fmtValue(environment.osVersion) }}</span></div>
            <div class="env-group"><strong>Session Timeouts</strong></div>
            <div class="env-item"><span class="env-label">Session Timeout:</span> <span class="env-value">{{ fmtMs(environment.sessionTimeout) }}</span></div>
            <div class="env-item"><span class="env-label">Kill Timeout:</span> <span class="env-value">{{ fmtMs(environment.killTimeout) }}</span></div>
            <div class="env-item"><span class="env-label">Expected ACK Time:</span> <span class="env-value">{{ fmtMs(environment.expectedAckTime) }}</span></div>
            <div class="env-item"><span class="env-label">Max Cache Time:</span> <span class="env-value">{{ fmtMs(environment.maxCacheTime) }}</span></div>
          </div>

          <!-- Components Panel -->
          <div v-if="isConnected && componentList.length > 0" class="panel full-width">
            <div class="panel-header">
              <h2>Components</h2>
              <button type="button" class="collapse-all-btn" @click="allCollapsed ? expandAll() : collapseAll()">
                {{ allCollapsed ? 'Expand All' : 'Collapse All' }}
              </button>
            </div>
            <div class="component-list">
              <div v-for="[id, component] in componentList" :key="id"
                   class="component-item" :class="{ ready: component.ready, enabled: component.enabled, 'header-only': isHeaderOnly(component) || isCollapsed(id) }">

                <!-- Title Row -->
                <div class="component-title-row"
                     :style="!isHeaderOnly(component) ? 'cursor: pointer' : ''"
                     @click="!isHeaderOnly(component) && toggleCollapse(id)">
                  <div class="component-title-left">
                    <span v-if="!isHeaderOnly(component)" class="collapse-chevron" :class="{ collapsed: isCollapsed(id) }">&#9660;</span>

                    <div class="component-name"
                         @mouseenter="startCharHover($event, component)"
                         @mouseleave="cancelCharHover()">
                      {{ component.deviceType }}
                    </div>
                    <div class="component-badges">
                      <span v-if="componentStatuses[id]?.statusBadge"
                            class="component-badge"
                            :class="[componentStatuses[id].statusClass, { 'fade-out': componentStatuses[id].isFading }]"
                            @animationend="onStatusBadgeFaded(id)">
                        {{ componentStatuses[id].statusBadge }}
                      </span>
                    </div>
                    <span class="component-badge"
                          :class="componentStatuses[id]?.readyClass">
                      {{ componentStatuses[id]?.readyText }}
                    </span>
                  </div>
                  <div class="component-controls" @click.stop>
                    <button v-if="hasCap(component, 'query')"
                            class="component-action-btn component-query-btn"
                            :class="btnClasses('query-' + id)"
                            :disabled="btnDisabled('query-' + id)"
                            @click="handleActionButton(id, 'query', 'query-' + id)">
                      <span class="btn-label">Query</span>
                      <span class="btn-spinner"></span>
                    </button>
                    <div class="toggle-container">
                      <toggle-switch :value="!!component.required"
                                     type="required"
                                     :pending="!!pendingToggles['required-' + id]"
                                     @toggle="handleToggleRequired(id)"></toggle-switch>
                      <span class="toggle-label">Required</span>
                    </div>
                    <div v-if="hasCap(component, 'enable') && hasCap(component, 'disable')"
                         class="toggle-container">
                      <toggle-switch :value="!!component.enabled"
                                     type="enabled"
                                     :disabled="!component.ready"
                                     :pending="!!pendingToggles['enabled-' + id]"
                                     @toggle="handleToggleEnabled(id)"></toggle-switch>
                      <span class="toggle-label">Enabled</span>
                    </div>
                  </div>
                </div>

                <!-- Component Actions (hidden when collapsed) -->
                <template v-if="!isCollapsed(id)">
                  <!-- Keypad-specific Actions -->
                  <template v-if="component.deviceType === 'KEY_PAD'">
                    <keypad-component
                      :component="component"
                      :component-id="id"
                      :ref="'keypad-' + id"
                      @log="log($event.message, $event.type)">
                    </keypad-component>
                  </template>

                  <!-- Headset (header only, no actions) -->
                  <template v-else-if="component.deviceType === 'HEADSET'">
                    <headset-component
                      :component="component"
                      :component-id="id">
                    </headset-component>
                  </template>

                  <!-- Generic Actions Row -->
                  <div v-else class="component-actions-row">
                  <!-- Left Column -->
                  <div class="component-action-column left-column">
                    <!-- Setup Section -->
                    <template v-if="hasCap(component, 'setup')">
                      <label class="component-action-label">Setup</label>
                      <select v-if="filteredCommands(component, 'Setup:').length > 0"
                              class="component-action-dropdown"
                              @change="onDropdownChange(id, 'setup', $event)">
                        <option value="">Select AEA command...</option>
                        <option v-for="[name, value] in filteredCommands(component, 'Setup:')"
                                :key="name" :value="value">{{ name }}</option>
                      </select>
                      <textarea class="component-action-textarea"
                                placeholder="Setup data (ITPS command)" rows="5"
                                v-model="componentInputs[id].setupText"></textarea>
                      <button class="component-action-btn"
                              :class="btnClasses('setup-' + id)"
                              :disabled="btnDisabled('setup-' + id)"
                              @click="handleActionButton(id, 'setup', 'setup-' + id)">
                        <span class="btn-label">Setup</span>
                        <span class="btn-spinner"></span>
                      </button>
                    </template>

                    <!-- Send Section -->
                    <template v-if="hasCap(component, 'send')">
                      <label class="component-action-label">Send</label>
                      <select v-if="filteredCommands(component, 'Send:').length > 0"
                              class="component-action-dropdown"
                              @change="onDropdownChange(id, 'send', $event)">
                        <option value="">Select AEA command...</option>
                        <option v-for="[name, value] in filteredCommands(component, 'Send:')"
                                :key="name" :value="value">{{ name }}</option>
                      </select>
                      <textarea class="component-action-textarea"
                                placeholder="Send data (ITPS command)" rows="5"
                                v-model="componentInputs[id].sendText"></textarea>
                      <div class="component-action-buttons">
                        <button class="component-action-btn"
                                :class="btnClasses('send-' + id)"
                                :disabled="btnDisabled('send-' + id)"
                                @click="handleActionButton(id, 'send', 'send-' + id)">
                          <span class="btn-label">Send</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'offer')"
                                class="component-action-btn"
                                :class="btnClasses('offer-' + id)"
                                :disabled="btnDisabled('offer-' + id)"
                                @click="handleActionButton(id, 'offer', 'offer-' + id)">
                          <span class="btn-label">Offer</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'process')"
                                class="component-action-btn"
                                :class="btnClasses('process-' + id)"
                                :disabled="btnDisabled('process-' + id)"
                                @click="handleActionButton(id, 'process', 'process-' + id)">
                          <span class="btn-label">Process</span>
                          <span class="btn-spinner"></span>
                        </button>
                      </div>
                    </template>

                    <!-- Play Section -->
                    <template v-if="hasCap(component, 'play')">
                      <label class="component-action-label">Play</label>
                      <textarea class="component-action-textarea"
                                placeholder="SSML or text" rows="5"
                                v-model="componentInputs[id].playText"></textarea>
                      <div class="component-action-buttons">
                        <button class="component-action-btn"
                                :class="btnClasses('play-' + id)"
                                :disabled="btnDisabled('play-' + id)"
                                @click="handleActionButton(id, 'play', 'play-' + id)">
                          <span class="btn-label">Play</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'pause')"
                                class="component-action-btn"
                                :class="btnClasses('pause-' + id)"
                                :disabled="btnDisabled('pause-' + id)"
                                @click="handleActionButton(id, 'pause', 'pause-' + id)">
                          <span class="btn-label">Pause</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'resume')"
                                class="component-action-btn"
                                :class="btnClasses('resume-' + id)"
                                :disabled="btnDisabled('resume-' + id)"
                                @click="handleActionButton(id, 'resume', 'resume-' + id)">
                          <span class="btn-label">Resume</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'stop')"
                                class="component-action-btn"
                                :class="btnClasses('stop-' + id)"
                                :disabled="btnDisabled('stop-' + id)"
                                @click="handleActionButton(id, 'stop', 'stop-' + id)">
                          <span class="btn-label">Stop</span>
                          <span class="btn-spinner"></span>
                        </button>
                      </div>
                    </template>
                  </div>

                  <!-- Right Column -->
                  <div class="component-action-column right-column">
                    <!-- Read Section -->
                    <template v-if="hasCap(component, 'read')">
                      <label class="component-action-label">Read</label>
                      <select v-if="testDataEntries(component).length > 0"
                              class="component-action-dropdown"
                              @change="onDropdownChange(id, 'read', $event)">
                        <option value="">Select test data...</option>
                        <option v-for="[name, value] in testDataEntries(component)"
                                :key="name" :value="value">{{ name }}</option>
                      </select>
                      <div class="data-display-container">
                        <label class="data-display-label">Data:</label>
                        <div class="data-display-box">
                          <template v-if="componentData[id]">{{ componentData[id] }}</template>
                        </div>
                      </div>
                      <input type="text" class="component-action-input timeout-input"
                             placeholder="Timeout ms (default: 30000)"
                             v-model="componentInputs[id].readTimeout">
                      <div class="component-action-buttons">
                        <button class="component-action-btn"
                                :class="btnClasses('read-' + id)"
                                :disabled="btnDisabled('read-' + id)"
                                @click="handleActionButton(id, 'read', 'read-' + id)">
                          <span class="btn-label">Read</span>
                          <span class="btn-spinner"></span>
                        </button>
                        <button v-if="hasCap(component, 'cancel')"
                                class="component-action-btn"
                                :class="btnClasses('cancel-' + id)"
                                :disabled="btnDisabled('cancel-' + id)"
                                @click="handleActionButton(id, 'cancel', 'cancel-' + id)">
                          <span class="btn-label">Cancel</span>
                          <span class="btn-spinner"></span>
                        </button>
                      </div>
                    </template>

                    <!-- Additional right-column buttons (forward, backward) -->
                    <div v-if="hasCap(component, 'forward') || hasCap(component, 'backward')"
                         class="component-action-buttons">
                      <button v-if="hasCap(component, 'forward')"
                              class="component-action-btn"
                              :class="btnClasses('forward-' + id)"
                              :disabled="btnDisabled('forward-' + id)"
                              @click="handleActionButton(id, 'forward', 'forward-' + id)">
                        <span class="btn-label">Forward</span>
                        <span class="btn-spinner"></span>
                      </button>
                      <button v-if="hasCap(component, 'backward')"
                              class="component-action-btn"
                              :class="btnClasses('backward-' + id)"
                              :disabled="btnDisabled('backward-' + id)"
                              @click="handleActionButton(id, 'backward', 'backward-' + id)">
                        <span class="btn-label">Backward</span>
                        <span class="btn-spinner"></span>
                      </button>
                    </div>
                  </div>
                </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Event Log Panel -->
          <div class="panel full-width panel-centered">
            <h2>Event Log</h2>
            <div class="log-container" ref="logContainer">
              <div v-for="entry in logEntries" :key="entry.id"
                   class="log-entry" :class="entry.type">
                {{ entry.message }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeout Warning Banner -->
      <div v-if="timeoutBanner.visible" class="timeout-banner">
        <div class="timeout-header">
          <strong>&#9888;&#65039; Session Timeout Warning</strong>
          <button class="dismiss-btn" @click="dismissTimeoutWarning">&times;</button>
        </div>
        <p>Application will be terminated in <span>{{ timeoutBanner.seconds }}</span> seconds</p>
      </div>

      <!-- Accessible Mode Banner -->
      <div v-if="accessibleModeBanner.visible" class="accessible-mode-banner">
        <div class="accessible-mode-header">
          <strong>Accessible Mode Activated</strong>
        </div>
        <p>Please acknowledge accessible mode within <span>{{ accessibleModeBanner.seconds }}</span> seconds</p>
        <button class="acknowledge-btn" @click="acknowledgeAccessibleMode">Acknowledge</button>
      </div>

      <!-- Reconnection Banner -->
      <div v-if="reconnectionBanner.visible" class="reconnection-banner">
        <div class="reconnection-content">
          <span class="reconnection-icon">&#9888;&#65039;</span>
          <div class="reconnection-text">
            <span class="reconnection-message">Connection Lost - Reconnecting...</span>
            <span v-if="reconnectionBanner.attempts > 0" class="reconnection-attempts">
              Attempt {{ reconnectionBanner.attempts }}
            </span>
          </div>
        </div>
        <div class="reconnection-actions">
          <button class="reconnection-btn retry-btn" @click="handleRetryNow">Retry Now</button>
          <button class="reconnection-btn cancel-btn" @click="handleCancelReconnection">Disconnect</button>
        </div>
      </div>

      <!-- Reconnection Success Toast -->
      <div v-if="reconnectionSuccess.visible" class="reconnection-success-toast">
        <span class="success-icon">&#10004;&#65039;</span>
        <span class="success-message">Reconnected Successfully</span>
      </div>

      <!-- Mixed Content Warning Banner -->
      <div v-if="mixedContentBanner.visible" class="mixed-content-banner">
        <div class="mixed-content-header">
          <strong>&#128274; Mixed Content Security Warning</strong>
          <button class="dismiss-btn" @click="handleMixedContentChoice('dismiss')">&times;</button>
        </div>
        <p>This page is served over <strong>{{ mixedContentBanner.currentProtocol }}</strong> but trying to connect to <strong>{{ mixedContentBanner.targetProtocol }}</strong>.</p>
        <p>Modern browsers block this for security reasons.</p>
        <div class="mixed-content-actions">
          <button class="suggested-url-btn" @click="handleMixedContentChoice('suggested')">
            Use {{ mixedContentBanner.suggestedUrl }}
          </button>
          <button class="continue-anyway-btn" @click="handleMixedContentChoice('continue')">Continue Anyway</button>
        </div>
      </div>

      <!-- Global Characteristics Popover -->
      <div v-if="charPopover.visible" class="char-popover"
           :style="{ top: charPopover.top + 'px', left: charPopover.left + 'px' }">
        <pre>{{ charPopover.json }}</pre>
      </div>
    </div>

    <!-- ARIA live region for screen readers -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="ariaLiveRegion"></div>

    <script type="module" src="js/tester-vue.js"></script>
  </body>
</html>
